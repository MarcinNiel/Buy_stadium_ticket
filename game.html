<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Memory Game</title>
    <link rel="stylesheet" type="text/css" href="min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
</head>
<body>
<div class="content">
    <div id="namer">
        <div id="namer-input" class="cheeky">
            <input type="text" id="inputName" name="namername" placeholder="Type your name">
        </div>
    </div>
    <button class="btn btn_restart"> Restart</button>
    <button class="btn btn_restart btn_back" id="back"> Back</button>
    <div class="stopwatch" id="timer">00:00:00</div>
    <div class="game_section">
    </div>
</div>
<script>
    // You can also require other files to run in this process
    require('./renderer.js');

    const electron = require('electron');
    const {ipcRenderer} = electron;
    const delay = require('delay');
    const fs = require('fs');
    var data = fs.readFileSync('cards.json', 'utf8');
    var array = JSON.parse(data);
    var pairs = array.length;
    var sum = 0;

    createGame();

    function createGame() {
        var gameBoard = document.querySelector('.game_section');
        gameBoard.innerHTML = '';

        for (i = 0; i < 2; i++) {

            array.forEach(element => {

                var newCard = '<div class="card_section">\n' +
                    '            <div class="flip-container memory-card">\n' +
                    '                <div class="flipper" data-image="' + element.name + '" >\n' +
                    '                    <div class="front">\n' +
                    '                        <!-- front content -->\n' +
                    '                        <div class="card_border "></div>\n' +
                    '                        <div class="card_logo_front"></div>\n' +
                    '                    </div>\n' +
                    '                    <div class="back">\n' +
                    '                        <!-- back content -->\n' +
                    '                        <div class="card_border"></div>\n' +
                    '                        <div class="card_logo_back" style=" ' +
                    '   background: url(' + element.image + ');\n' +
                    '   background-repeat: no-repeat;\n' +
                    '    background-size: cover;\n' +
                    '    background-position: center;"></div>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </div>\n' +
                    '        </div>';
            gameBoard.insertAdjacentHTML('beforeend', newCard);

        })
        }


    }

    class Stopwatch {
        constructor(display) {
            this.running = false;
            this.display = display;
            this.reset();
            this.print(this.times);
        }

        reset() {
            this.times = [0, 0, 0];
            this.print();
        }

        start() {
            if (!this.time) this.time = performance.now();
            if (!this.running) {
                this.running = true;
                requestAnimationFrame(this.step.bind(this));
            }
        }

        stop() {
            this.running = false;
            this.time = null;
        }

        restart() {
            if (!this.time) this.time = performance.now();
            if (!this.running) {
                this.running = true;
                requestAnimationFrame(this.step.bind(this));
            }
            this.reset();
        }

        clear() {
            clearChildren(this.results);
        }

        step(timestamp) {
            if (!this.running) return;
            this.calculate(timestamp);
            this.time = timestamp;
            this.print();
            requestAnimationFrame(this.step.bind(this));
        }

        calculate(timestamp) {
            var diff = timestamp - this.time;
            // Hundredths of a second are 100 ms
            this.times[2] += diff / 10;
            // Seconds are 100 hundredths of a second
            if (this.times[2] >= 100) {
                this.times[1] += 1;
                this.times[2] -= 100;
            }
            // Minutes are 60 seconds
            if (this.times[1] >= 60) {
                this.times[0] += 1;
                this.times[1] -= 60;
            }
        }

        print() {
            this.display.innerText = this.format(this.times);
        }

        format(times) {
            return `\
${pad0(times[0], 2)}:\
${pad0(times[1], 2)}:\
${pad0(Math.floor(times[2]), 2)}`;
        }
    }

    let stopwatch = new Stopwatch(
        document.querySelector('.stopwatch'));

    function pad0(value, count) {
        var result = value.toString();
        for (; result.length < count; --count)
            result = '0' + result;
        return result;
    }

    const cards = document.querySelectorAll('.flipper');

    class Card {
        constructor(element) {
            this.card = element;
            this.data = element.dataset.image;
        }

        flip() {
            this.card.classList.toggle('flip_card');
        }

        disable() {

            this.card.removeEventListener("click", clickCard);
        }

        enable() {
            this.card.addEventListener("click", clickCard);
        }

        isMatch(dataToMatch) {
            return this.data === dataToMatch;
        }

    }

    let firstCard, secondCard;

    function clickCard() {
        stopwatch.start();

        if (firstCard == null) {
            firstCard = new Card(this);
            firstCard.flip();
        } else {
            if (this != firstCard.card && secondCard == null) {
                secondCard = new Card(this);
                secondCard.flip();
            }
        }

        if (secondCard != null && firstCard != null) {
            (firstCard.isMatch(secondCard.data)) ? disableCards() : unflipCards();
        }

        if (sum == pairs) {
            stopwatch.stop();
            addRecord(document.getElementById('inputName').value, document.getElementById('timer').textContent);
            Swal.fire(
                'Good job!',
                'Your score is saved in Record List!',
                'success'
            )
        }
    }

    function addRecord(pName, pTime) {
        pName = pName === "" ? "Unknow" : pName;
        let dataScore = fs.readFileSync('data.json', 'utf8');
        let arrayScore = JSON.parse(dataScore);

        arrayScore.push({name: pName, time: pTime});
        fs.writeFileSync('data.json', JSON.stringify(arrayScore), 'utf8');
    }

    function disableCards() {
        firstCard.disable();
        secondCard.disable();
        firstCard = null;
        secondCard = null;
        sum += 1;
    }

    function unflipCards() {
        setTimeout(function () {
            firstCard.flip();
            secondCard.flip();
            firstCard = null;
            secondCard = null;
        }, 500);

    }

    let cardsOrder = document.querySelectorAll('.card_section');

    (function shuffle() {

        cardsOrder.forEach(card => {
            let randomPos = Math.floor(Math.random() * 10);
        card.style.order = randomPos;
    })
    })();

    function shuffle() {
        cardsOrder.forEach(card => {
            let randomPos = Math.floor(Math.random() * 10);
        card.style.order = randomPos;
    })
    }

    document.querySelector('.btn_restart').addEventListener('click', () => {
        stopwatch.stop();
    stopwatch.reset();
    resetGame();
    sum = 0;
    });

    function resetGame() {
        shuffle();
        cards.forEach(card => {card.classList.contains('flip_card') ? card.classList.toggle('flip_card') : '';})

        cards.forEach(card => card.addEventListener('click', clickCard))

        firstCard = null;
        secondCard = null;
    }

    cards.forEach(card => card.addEventListener('click', clickCard))

    const back = document.getElementById('back');
    back.addEventListener('click', function () {
        ipcRenderer.send('btn:exit:menu');
    });
</script>
</body>
</html>